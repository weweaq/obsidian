## 第八讲

t1
![[Pasted image 20240719224533.png]]

t2
![[Pasted image 20240719224625.png]]


在t1事务中，若t2事务修改完同一行id为2的数据后提交，t1也对id为2的数据进行修改，那么修改后会看到t2事务的修改已经能在t1中查询到。

解答：

别的事务改的，自己事务当然看不到，但是当自己的事务进行更改后，对应数据上也会记录上自己事务的版本号，此时自己事务就能看见了~
![[Pasted image 20240719232812.png]]


--- 
第十讲 MySQL为什么有时候会选错索引？

[【MySQL高级】MySQL找出执行慢的SQL【慢查询日志使用与分析】_mysql 慢sql日志-CSDN博客](https://blog.csdn.net/laodanqiu/article/details/131423834)

慢日志位置
/c/ProgramData/MySQL/MySQL\ Server\ 8.0/Data/DESKTOP-74LK9LN-slow.log


![[Pasted image 20240727065319.png]]![[Pasted image 20240727071229.png]]


通过在云服务器上搭建mysql后，可以看到对应的慢sql日志

```sql
SHOW VARIABLES LIKE '%slow_query_log%';  
SET GLOBAL slow_query_log = 1;  
  
SHOW VARIABLES LIKE 'long_query_time%';  
SET GLOBAL long_query_time = 1;
```
![[Pasted image 20240813233423.png]]
![[Pasted image 20240813233454.png]]

![[Pasted image 20240813233238.png]]

![[Pasted image 20240813233511.png]]



## 第十二讲 为什么我的MySQL会“抖”一下？


### 为什么会抖一下

普遍来说，mysql所谓的”抖“一下是指突然间的数据吞吐量降低，此时多是因为内存脏页在flush操作，转换成干净页。
> 当内存数据页跟磁盘数据页内容不一致的时候，我们称这个内存页为“脏页”。内存数据写入到磁盘后，内存和磁盘上的数据页的内容就一致了，称为“干净页”。

### 抖动的具体场景

主要分为以下四种场景：

第一种场景是，粉板满了，记不下了。对应的就是 InnoDB 的 redo log 写满了，此时需要刷一部分脏页到磁盘里。

第二种场景是，老板感觉记不住了。对应为当出现数据行更新，且数据页不在内存中的时候，mysql需要从硬盘load对应数据到内存中，而又内存满了，所以就必须把内存中的部分脏数据页刷到磁盘中，重新使用。

第三种场景是，生意不忙的时候，或者打烊之后。这时候柜台没事，掌柜闲着也是闲着，不如更新账本。对应场景为mysql负载低时，可以后台刷新数据页，

第四种场景是，年底了咸亨酒店要关门几天，需要把账结清一下。即重启mysql的时候~

### 为什么要防抖

上述四种场景中，第三和四都是正常场景，主要可调控的还是第一二两种场景。

在进行数据页刷入磁盘时，刷脏页是常态，但是脏页比例控制不当，可能出现这两种明显影响性能的情况：

1. 一次查询太多数据，导致一次性非常多的脏页刷入磁盘，导致查询时间异常的长。
2. redolog日志写满，更新全部堵住，对于写敏感的业务影响巨大。

所以，合理控制脏页比例，成为innodb必备的机制。

### 如何防抖

#### 1. 告诉innodb正确的磁盘io能力

正确地告诉 InnoDB 所在主机的 IO 能力，这样 InnoDB 才能知道需要全力刷脏页的时候，可以刷多快。而innodb_io_capacity 这个参数控制了InnoDB 刷入磁盘的能力，而这个值建议设置成磁盘的 IOPS。

>IOPS（Input/Output Operations Per Second）是一个衡量计算机存储设备性能的重要指标，它表示的是每秒钟能够完成的输入/输出操作的数量。IOPS主要用于评估存储设备处理随机访问的能力，特别是对于那些频繁进行小块数据读写的场景，比如数据库操作。
>
>IOPS与另一个常见的性能指标——带宽（Bandwidth）不同。带宽通常指的是每秒可以传输的数据总量，而IOPS则侧重于操作的频率。例如，一个硬盘可能具有较高的带宽（例如每秒几百兆字节），但较低的IOPS（例如每秒几百次操作），这意味着虽然它可以快速传输大量数据，但在处理大量随机小块数据读写时可能会表现不佳。
>
在选择存储解决方案时，根据应用的需求来平衡IOPS和带宽是非常重要的。例如，对于需要频繁随机访问的小文件系统，高IOPS可能是关键；而对于连续的大文件读写，高带宽则更为重要。



磁盘的 IOPS 可以通过 fio 这个工具来测试，下面的语句是我用来测试磁盘随机读写的命令：
```bash
 fio -filename="zhangweitestio" -direct=1 -iodepth 1 -thread -rw=randrw -ioengine=psync -bs=16k -size=500M -numjobs=10 -runtime=10 -group_reporting -name=mytest 
```

![[Pasted image 20240814220049.png]]

我在自己的云服务器上运行后，可以看到读写的iops分别为836和869。

而看一下innodb默认的innodb_io_capacity为200，所以可将其改为800
![[Pasted image 20240814221240.png]]


#### 2. 控制io速度

虽然我们现在已经定义了“全力刷脏页”的行为，但毕竟磁盘能力不能只用来刷脏页，还需要服务用户请求。所以会还需一定的机制要控制刷脏页的速度。

刷脏页主要需要考虑两方面：1. redolog的写盘比例  2.内存中脏页的最大可容忍占比 ，取两者的较大值控制刷脏页的速度是否为百分之百
![[Pasted image 20240814220757.png|300]]

redolog的写盘速度不好控制，但是脏页的最大可容忍占比可以自行设置

![[Pasted image 20240814221424.png]]

参数 innodb_max_dirty_pages_pct 是脏页比例上限，默认值是 90%，所以平时要多关注脏页比例，不要让它经常接近90%。

其中，脏页比例是通过 Innodb_buffer_pool_pages_dirty/Innodb_buffer_pool_pages_total 得到
![[Pasted image 20240814221539.png]]

> 注意此时为0，是没有脏页哦~ 

此时构造一个有脏页的情况，在第八讲中构造了一个具有10w条数据的表，现在对全部的数据进行更新，那么一定会出现将数据页读取到内存中，进行更新，写入redolog的步骤，此时内存中的数据与磁盘中数据还不一致（还未写入磁盘，出现脏页），再观察这个比例是否为0.

![[Pasted image 20240814222215.png]]

![[Pasted image 20240814222357.png]]
可以看到脏页出现了，比例这么小，分析应该是该表非常小，只有三个字段，对于16kb的数据页，一页就能存放好多数据，所以实际也没用到几个数据页~


最后介绍一下连坐机制：

在准备刷一个脏页的时候，如果这个数据页旁边的数据页刚好是脏页，就会把这个“邻居”也带着一起刷掉；而且这个把“邻居”拖下水的逻辑还可以继续蔓延，也就是对于每个邻居数据页，如果跟它相邻的数据页也还是脏页的话，也会被放到一起刷，这可能会让你的查询速度比平时慢

在 InnoDB 中，innodb_flush_neighbors 参数就是用来控制这个行为。建议ssd关闭这个设置，而机械硬盘可以开启这个设置，减少随机io的次数。